<style>
  .gift-form-input::placeholder {
    color: #888 !important;
  }
  .gift-form-input::-webkit-input-placeholder {
    color: #888 !important;
  }
  .gift-form-input::-moz-placeholder {
    color: #888 !important;
  }
  .gift-form-input:-ms-input-placeholder {
    color: #888 !important;
  }
</style>

<%# Determine LINE linkage directly from current_user to avoid stale locals %>
<% line_connected = if local_assigns.key?(:line_connected)
                      local_assigns[:line_connected]
                    elsif defined?(current_user) && current_user.present?
                      current_user.line_connected?
                    else
                      false
                    end %>

<%= form_with model: gift_person, data: { 
      controller: (local_assigns[:edit_mode] || local_assigns[:new_mode]) ? nil : "gift-person-form",
      "gift-person-form-target": (local_assigns[:edit_mode] || local_assigns[:new_mode]) ? "form" : nil
    } do |f| %>
  <%= render 'shared/error_messages', object: f.object %>
  
  <!-- 名前入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :name, "名前", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_field :name, 
        data: { 
          "gift-person-form-target": "input"
        },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background-color: white;
          color: black;
        ",
        placeholder: "例：田中太郎、花子さん、おじいちゃんなど",
        required: true,
        maxlength: 255 %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      ギフト相手の名前またはニックネームを入力してください（必須）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:name].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:name].first %>
      </div>
    <% end %>
  </div>

  <!-- ギフト相手のプロフィール画像セクション -->
  <div style="margin-bottom: 24px; text-align: left;">
    <label style="
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    ">
      <i class="fas fa-image" style="margin-right: 4px; color: #FC913A;"></i>
      プロフィール画像
    </label>
    
    <div style="display: flex; align-items: start; gap: 20px; flex-wrap: wrap;">
      <!-- 現在の画像表示 -->
      <div style="flex-shrink: 0;">
        <div style="position: relative;">
          <% if gift_person.has_avatar? && display_avatar(gift_person, :large) %>
            <%= image_tag display_avatar(gift_person, :large), 
                data: { "gift-person-form-target": "currentAvatar" },
                style: "width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #e1e5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" %>
          <% else %>
            <div data-gift-person-form-target="currentAvatar" style="width: 80px; height: 80px; border-radius: 50%; background-color: #f8f9fa; border: 3px solid #e1e5e9; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <i class="fas fa-user" style="font-size: 24px; color: #adb5bd;"></i>
            </div>
          <% end %>
          
          <!-- プレビュー画像（Stimulus で制御） -->
          <img data-gift-person-form-target="avatarPreview" src="" alt="プレビュー" 
               style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #FC913A; position: absolute; top: 0; left: 0; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        </div>
      </div>
      
      <div style="flex: 1; min-width: 200px;">
        <!-- ファイル選択 -->
        <div style="margin-bottom: 12px;">
          <%= f.label :avatar, "新しい画像を選択", style: "
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #666;
          " %>
          <%= f.file_field :avatar, 
              data: { 
                "gift-person-form-target": "avatarInput",
                "action": "change->gift-person-form#avatarSelected"
              },
              accept: "image/jpeg,image/jpg,image/png,image/webp",
              style: "
                width: 100%;
                font-size: 13px;
                color: #555;
                padding: 8px;
                border: 1px solid #e1e5e9;
                border-radius: 4px;
                box-sizing: border-box;
              " %>
        </div>
        
        <!-- プレビューリセットボタン -->
        <div style="margin-bottom: 12px;">
          <button type="button" 
                  data-gift-person-form-target="resetButton"
                  data-action="click->gift-person-form#resetAvatarPreview"
                  style="
                    display: none;
                    padding: 6px 12px;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    background-color: #fff;
                    color: #666;
                    font-size: 12px;
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                  ">
            <i class="fas fa-undo" style="margin-right: 4px;"></i>
            選択をリセット
          </button>
        </div>
        
        <!-- 削除オプション -->
        <% if gift_person.has_avatar? %>
          <div style="margin-bottom: 8px;">
            <%= f.check_box :remove_avatar, { 
                data: { 
                  "gift-person-form-target": "removeCheckbox",
                  "action": "change->gift-person-form#removeAvatarToggled"
                }, 
                class: "checkbox checkbox-error",
                style: "margin-right: 6px;" 
              }, "1", "" %>
            <%= f.label :remove_avatar, "現在のプロフィール画像を削除する", 
                style: "font-size: 12px; color: #dc3545; font-weight: 500; cursor: pointer;" %>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      JPEG、PNG、WEBP形式のファイルをアップロードできます（任意、最大5MB）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:avatar].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:avatar].first %>
      </div>
    <% end %>
  </div>

  <!-- 関係性選択 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :relationship_id, "関係性", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.select :relationship_id, 
        options_from_collection_for_select(
          Relationship.ordered, 
          :id, 
          :name, 
          gift_person&.relationship_id
        ), 
        { 
          prompt: "関係性を選択してください"
        }, 
        { 
          data: { "gift-person-form-target": "input" },
          class: "gift-form-input",
          style: "
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            background-color: white;
            color: black;
          ",
          required: true
        } %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      この相手との関係性を選択してください（必須）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:relationship_id].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:relationship_id].first %>
      </div>
    <% end %>
  </div>

  <!-- 誕生日入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :birthday, "誕生日", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.date_field :birthday, 
        data: { "gift-person-form-target": "input" },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background-color: white;
          color: black;
        ",
        max: Date.current.strftime('%Y-%m-%d') %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      誕生日を入力すると、プレゼント時期の参考になります（任意）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:birthday].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:birthday].first %>
      </div>
    <% end %>
  </div>

  <% if local_assigns[:new_mode] && local_assigns[:remind] %>
    <% remind_for_partial = local_assigns[:remind] %>
    <% remind_gift_people = local_assigns[:remind_gift_people] || [] %>
    <% remind_form_values = local_assigns[:remind_form_values] || {} %>
    <% remind_form_enabled = line_connected && local_assigns.fetch(:remind_form_enabled, remind_form_values.values.any?(&:present?)) %>
    <div style="margin-bottom: 24px; text-align: left;">
      <label style="
        color-scheme: light;
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 14px;
      ">
        通知設定
      </label>
      <select
        class="gift-form-input <%= line_connected ? '' : 'bg-gray-100 text-gray-400 cursor-not-allowed' %>"
        style="
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background-color: white;
          color: black;
          color-scheme: light;
        "
        <%= 'disabled' unless line_connected %>
        data-action="<%= 'change->gift-person-form#toggleNotificationSection' if line_connected %>"
        data-gift-person-form-target="notificationToggle input">
        <option value="" <%= 'selected' unless remind_form_enabled %>>設定しない</option>
        <option value="set" <%= 'selected' if remind_form_enabled %>>通知日を設定する</option>
      </select>
      <% section_style = "margin-top: 16px;" %>
      <% section_style += ' display: none;' unless remind_form_enabled && line_connected %>
      <div
        data-gift-person-form-target="notificationSection"
        style="<%= section_style %>">
        <% if line_connected %>
          <%= fields_for :remind, remind_for_partial do |remind_form| %>
            <%= render 'reminds/form',
                form_builder: remind_form,
                remind: remind_for_partial,
                gift_people: remind_gift_people,
                mode: :new,
                back_path: reminds_path,
                submit_label: "記念日を設定",
                show_gift_person_select: false,
                show_actions: false,
                show_status_card: false,
                notification_days_before: remind_form_values[:notification_days_before],
                notification_time: remind_form_values[:notification_time] %>
          <% end %>
        <% end %>
      </div>
      <div class="mt-2 text-xs text-gray-500">
        <i class="fas fa-info-circle mr-1"></i>
        <% if line_connected %>
          通知を設定すると、記念日前にリマインドを受け取れます（任意）
        <% else %>
          通知設定を利用するにはLINE連携が必要です。
          <div class="mt-2 inline-flex items-center gap-2">
            <%= button_tag type: "submit",
                form: "line-omniauth-authorize-form",
                class: "inline-flex items-center px-3 py-1.5 border border-transparent rounded-md text-xs font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" do %>
              <i class="fab fa-line mr-1"></i>
              LINE連携する
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- 好きなもの入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :likes, "好きなもの・趣味", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_area :likes, 
        data: { 
          "gift-person-form-target": "input"
        },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          min-height: 80px;
          resize: vertical;
          background-color: white;
          color: black;
        ",
        placeholder: "例：読書、映画鑑賞、スイーツ、花、アクセサリーなど",
        maxlength: 30 %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      相手の好きなものや趣味を記録しておくと、ギフト選びの参考になります（任意、最大30文字）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:likes].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:likes].first %>
      </div>
    <% end %>
  </div>

  <!-- 嫌いなもの入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :dislikes, "苦手なもの・アレルギー", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_area :dislikes, 
        data: { 
          "gift-person-form-target": "input"
        },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          min-height: 80px;
          resize: vertical;
          background-color: white;
          color: black;
        ",
        placeholder: "例：辛いもの、香りの強いもの、特定の食材アレルギーなど",
        maxlength: 30 %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      相手の苦手なものやアレルギーを記録して、適切なギフト選びに役立てましょう（任意、最大30文字）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:dislikes].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:dislikes].first %>
      </div>
    <% end %>
  </div>

  <!-- 住所入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :address, "住所", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_area :address, 
        data: { 
          "gift-person-form-target": "input"
        },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          min-height: 80px;
          resize: vertical;
          background-color: white;
          color: black;
        ",
        placeholder: "例：東京都新宿区西新宿x-x-x、〒xxx-xxxxx",
        maxlength: 100 %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      相手の住所を記録しておくと、配送先として便利です（任意、最大100文字）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:address].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:address].first %>
      </div>
    <% end %>
  </div>

  <!-- メモ入力 -->
  <div style="margin-bottom: 32px; text-align: left;">
    <%= f.label :memo, "メモ", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_area :memo, 
        data: { 
          "gift-person-form-target": "input memoField",
          "action": "input->gift-person-form#memoInput"
        },
        class: "gift-form-input",
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          min-height: 100px;
          resize: vertical;
          background-color: white;
          color: black;
        ",
        placeholder: "相手に関するその他のメモ、過去のギフトの反応、特記事項など...",
        maxlength: 100 %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      相手に関する自由なメモを記録してください（任意、最大100文字）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_person.errors[:memo].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_person.errors[:memo].first %>
      </div>
    <% end %>
  </div>

  <!-- 送信ボタン -->
  <div style="margin-bottom: 32px;">
    <%= f.submit nil, 
        data: { 
          "gift-person-form-target": (local_assigns[:edit_mode] || local_assigns[:new_mode]) ? "submitButton" : nil 
        },
        style: "
          width: 100%;
          padding: 16px;
          background: linear-gradient(135deg, #FC913A 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        " %>
  </div>
<% end %>

<% unless line_connected %>
  <%= form_with url: user_line_omniauth_authorize_path,
      method: :post,
      local: true,
      data: { turbo: false },
      html: { id: "line-omniauth-authorize-form", style: "display:none;" } do %>
  <% end %>
<% end %>
