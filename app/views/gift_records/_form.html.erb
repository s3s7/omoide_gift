<style>
  .gift-form-input::placeholder {
    color: #888 !important;
  }
  .gift-form-input::-webkit-input-placeholder {
    color: #888 !important;
  }
  .gift-form-input::-moz-placeholder {
    color: #888 !important;
  }
  .gift-form-input:-ms-input-placeholder {
    color: #888 !important;
  }
</style>

<% is_received = (gift_direction_value(gift_record) == "received") %>

<% form_options = { data: { controller: "gift-records image-preview", action: "submit->gift-records#validateForm" } } %>
<% if gift_record.new_record? && (defined?(form_context) && form_context == :received) %>
  <% form_options[:url] = create_received_gift_records_path %>
<% end %>

<%= form_with model: gift_record, **form_options do |f| %>
  <%= render 'shared/error_messages', object: f.object %>
  
  <!-- 削除対象画像IDの隠しフィールド（フォーム内に配置） -->
  <div id="delete-image-fields" style="display: none;" data-image-preview-target="deleteImageContainer"></div>
  
  <!-- イベント選択 -->
  <div style="margin-bottom: 24px; text-align: left;" data-controller="event-selector">
    <%= f.label :event_id, "イベント", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.select :event_id, 
        options_from_collection_for_select(
          (@events || []), 
          :id, 
          :name, 
          gift_record&.event_id
        ), 
        { 
          prompt: "イベントを選択してください"
        }, 
        { 
          style: "
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            background-color: white;
            color: black;
          ",
          id: "gift_record_event_id",
          required: true,
          data: { gift_records_target: "eventSelect", event_selector_target: "select", action: "pointerdown->gift-records#stopEvent touchstart->gift-records#stopEvent click->gift-records#stopEvent change->gift-records#stopEvent" }
        } %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;" data-event-selector-target="help">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      このギフトに関連するイベントを選択してください（必須）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_record.errors[:event_id].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:event_id].first %>
      </div>
    <% end %>
    
    <!-- 人気のイベント表示 -->
    <% if @popular_events&.any? %>
      <div style="margin-top: 12px;">
        <small style="color: #888;">よく使われるイベント: </small>
        <% @popular_events.each do |event| %>
          <button type="button" 
                  style="
                    display: inline-block;
                    padding: 4px 8px;
                    margin-right: 6px;
                    margin-bottom: 6px;
                    border: 1px solid #FC913A;
                    background-color: transparent;
                    color: #FC913A;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  " 
                  data-action="click->gift-records#setEventSelection"
                  data-gift-records-event-id-param="<%= event.id %>"
                  onmouseover="this.style.backgroundColor='#FC913A'; this.style.color='white';"
                  onmouseout="this.style.backgroundColor='transparent'; this.style.color='#FC913A';">
            <%= truncate(event.display_name, length: 10) %>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
  <div style="margin-bottom: 24px; text-align: left;" data-controller="gift-date-selector">
    <%= f.label :gift_people_id, (is_received ? "贈ってくれた人" : "贈る相手"), style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%
      # エラー時の選択値を決定
      if @gift_person&.errors&.any? || params[:gift_record]&.[](:gift_people_id) == "new"
        selected_value = "new"
      else
        selected_value = gift_record&.gift_people_id
      end

      # オプションを作成
      gift_people_options = options_from_collection_for_select(@gift_people, :id, :name, selected_value == "new" ? nil : selected_value)
      new_option = options_for_select([["新たに追加する", "new"]], selected_value == "new" ? "new" : nil)
      all_options = gift_people_options + new_option
    %>
    <%= f.select :gift_people_id,
        all_options.html_safe,
        {
          prompt: (is_received ? "贈ってくれた人を選択してください" : "贈る相手を選択してください")
        },
        {
          style: "
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            background-color: white;
            color: black;
          ",
          id: "gift_record_gift_people_id",
          required: true,
          data: { 
            gift_records_target: "giftPeopleSelect",
            action: "pointerdown->gift-records#stopEvent touchstart->gift-records#stopEvent change->gift-records#giftPersonChanged change->gift-records#stopEvent click->gift-records#stopEvent"
          }
        } %>

    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      <%= is_received ? "ギフトをくれた人を選択してください（必須）" : "ギフトを贈った人を選択してください（必須）" %>
    </div>
  </div>
  
  <!-- 新しいギフト相手の入力フィールド -->
  <% show_fields = @gift_person&.errors&.any? || params[:gift_record]&.[](:gift_people_id) == "new" %>
  <div id="new_gift_person_fields" 
       data-gift-records-target="newGiftPersonFields"
       style="margin-bottom: 24px; <%= show_fields ? 'display: block;' : 'display: none;' %>">
    <div style="
      border: 2px solid #e1e5e9;
      padding: 20px;
      border-radius: 8px;
      background-color: #f8f9fa;
      text-align: left;
    ">
      <h6 style="
        margin: 0 0 20px 0;
        font-size: 16px;
        font-weight: 600;
        color: #333;
      ">新しいギフト相手の情報</h6>
      
      <!-- ギフト相手のエラーメッセージ -->
      <% if @gift_person&.errors&.any? %>
        <div style="
          background-color: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
          padding: 12px;
          border-radius: 6px;
          margin-bottom: 16px;
        ">
          <ul style="margin: 0; padding-left: 20px;">
            <% @gift_person.errors.each do |error| %>
              <li><%= error.full_message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_name", "名前", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= text_field_tag "gift_person[name]", @gift_person&.name || params.dig(:gift_person, :name), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              background-color: white;
              color: black;
            ",
            placeholder: "相手の名前を入力",
            class: "gift-form-input",
            id: "gift_person_name" %>
      </div>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_relationship_id", "関係性", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= select_tag "gift_person[relationship_id]", 
            options_from_collection_for_select(Relationship.ordered, :id, :name, @gift_person&.relationship_id || params.dig(:gift_person, :relationship_id)), 
            { 
              prompt: "関係性を選択",
              style: "
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e1e5e9;
                border-radius: 6px;
                font-size: 14px;
                box-sizing: border-box;
                background-color: white;
                color: black;
              ",
              id: "gift_person_relationship_id",
              data: { action: "pointerdown->gift-records#stopEvent touchstart->gift-records#stopEvent change->gift-records#stopEvent click->gift-records#stopEvent" }
            } %>
      </div>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_birthday", "誕生日", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= date_field_tag "gift_person[birthday]", @gift_person&.birthday || params.dig(:gift_person, :birthday), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              background-color: white;
              color: black;
              color-scheme: light;
            ",
            id: "gift_person_birthday" %>
      </div>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_likes", "好きなもの", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= text_field_tag "gift_person[likes]", @gift_person&.likes || params.dig(:gift_person, :likes), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              background-color: white;
              color: black;
            ",
            placeholder: "好きなものを入力",
            class: "gift-form-input",
            id: "gift_person_likes" %>
      </div>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_dislikes", "嫌いなもの", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= text_field_tag "gift_person[dislikes]", @gift_person&.dislikes || params.dig(:gift_person, :dislikes), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              background-color: white;
              color: black;
            ",
            placeholder: "嫌いなものを入力",
            class: "gift-form-input",
            id: "gift_person_dislikes" %>
      </div>
      
      <div style="margin-bottom: 16px;">
        <%= label_tag "gift_person_address", "住所", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= text_area_tag "gift_person[address]", @gift_person&.address || params.dig(:gift_person, :address), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              min-height: 80px;
              resize: vertical;
              background-color: white;
              color: black;
            ",
            placeholder: "例：東京都新宿区西新宿x-x-x、〒xxx-xxxxx",
            class: "gift-form-input",
            maxlength: 100,
            id: "gift_person_address" %>
      </div>
      
      <div style="margin-bottom: 0;">
        <%= label_tag "gift_person_memo", "メモ", style: "
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
          font-size: 14px;
        " %>
        <%= text_area_tag "gift_person[memo]", @gift_person&.memo || params.dig(:gift_person, :memo), 
            style: "
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 6px;
              font-size: 14px;
              box-sizing: border-box;
              min-height: 80px;
              resize: vertical;
              background-color: white;
              color: black;
            ",
            placeholder: "メモを入力",
            class: "gift-form-input",
            id: "gift_person_memo" %>
      </div>
    </div>
    
  </div>



  <!-- ギフト日付入力 -->
  <div style="margin-bottom: 24px; text-align: left;" data-controller="gift-date-selector">
    <%= f.label :gift_at, (is_received ? "ギフトをもらった日" : "ギフトを贈った日"), style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.date_field :gift_at, 
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background-color: white;
          color: black;
          color-scheme: light;
        ",
        value: gift_record.gift_at&.strftime('%Y-%m-%d'),
        min: 100.years.ago.strftime('%Y-%m-%d'),
        max: 1.year.from_now.strftime('%Y-%m-%d'),
        required: true,
        data: { gift_records_target: "dateField", gift_date_selector_target: "input" } %>
    
    <!-- ヘルプテキスト -->
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      <%= is_received ? "ギフトをもらった日を選択してください（必須）" : "ギフトを贈った日または贈る予定日を選択してください（必須）" %>
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_record.errors[:gift_at].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:gift_at].first %>
      </div>
    <% end %>
    
    <!-- 便利なクイック選択ボタン -->
    <div style="margin-top: 12px;">
      <small style="color: #888;">クイック選択: </small>
      <button type="button" 
              style="
                display: inline-block;
                padding: 4px 8px;
                margin-right: 6px;
                margin-bottom: 6px;
                border: 1px solid #FC913A;
                background-color: transparent;
                color: #FC913A;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              " 
              data-action="click->gift-date-selector#setDate"
              data-gift-date-selector-type-param="today"
              onmouseover="this.style.backgroundColor='#FC913A'; this.style.color='white';"
              onmouseout="this.style.backgroundColor='transparent'; this.style.color='#FC913A';">
        今日
      </button>
      <button type="button" 
              style="
                display: inline-block;
                padding: 4px 8px;
                margin-right: 6px;
                margin-bottom: 6px;
                border: 1px solid #FC913A;
                background-color: transparent;
                color: #FC913A;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              " 
              data-action="click->gift-date-selector#setDate"
              data-gift-date-selector-type-param="yesterday"
              onmouseover="this.style.backgroundColor='#FC913A'; this.style.color='white';"
              onmouseout="this.style.backgroundColor='transparent'; this.style.color='#FC913A';">
        昨日
      </button>
      <button type="button" 
              style="
                display: inline-block;
                padding: 4px 8px;
                margin-right: 6px;
                margin-bottom: 6px;
                border: 1px solid #FC913A;
                background-color: transparent;
                color: #FC913A;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              "
              data-action="click->gift-date-selector#setDate"
              data-gift-date-selector-type-param="week_ago"
              onmouseover="this.style.backgroundColor='#FC913A'; this.style.color='white';"
              onmouseout="this.style.backgroundColor='transparent'; this.style.color='#FC913A';">
        1週間前
      </button>
    </div>
  </div>
  <!-- ギフトアイテム名入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :item_name, "ギフトアイテム名", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_field :item_name, 
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background-color: white;
          color: black;
        ",
        placeholder: "例：花束、チョコレート、アクセサリーなど",
        class: "gift-form-input",
        required: true,
        maxlength: 30 %>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      <%= is_received ? "もらったギフトの名前を入力してください（必須、最大30文字）" : "贈ったギフトの名前を入力してください（必須、最大30文字）" %>
    </div>
    
    <% if gift_record.errors[:item_name].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:item_name].first %>
      </div>
    <% end %>
  </div>

  <!-- アイテムカテゴリー選択 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :gift_item_category_id, "アイテムカテゴリー", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.collection_select :gift_item_category_id,
          GiftItemCategory.order(:name), :id, :name,
          { include_blank: "選択してください" },
          {
            style: "
              width: 100%;
              padding: 14px 16px;
              border: 2px solid #e1e5e9;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
              transition: border-color 0.3s ease;
              background-color: white;
              color: black;
            ",
            id: "gift_record_gift_item_category_id",
            data: { action: "pointerdown->gift-records#stopEvent touchstart->gift-records#stopEvent change->gift-records#stopEvent click->gift-records#stopEvent" }
          }
    %>

    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      アイテムのカテゴリーを選択してください（任意）
    </div>
  </div>

  <!-- ギフト金額入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :amount, "金額", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <div style="display: flex; align-items: center;">
      <span style="
        background-color: #e9ecef;
        border: 2px solid #e1e5e9;
        border-right: none;
        border-radius: 8px 0 0 8px;
        padding: 14px 16px;
        font-size: 16px;
        color: #6c757d;
      ">¥</span>
      <%= f.number_field :amount, 
          style: "
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 0 8px 8px 0;
            border-left: none;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            background-color: white;
            color: black;
          ",
          placeholder: "3000",
          class: "gift-form-input",
          min: 1,
          step: 1 %>
    </div>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      ギフトの金額を入力してください（任意、1円以上）
    </div>
    
    <% if gift_record.errors[:amount].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:amount].first %>
      </div>
    <% end %>
  </div>

  <!-- メモ入力 -->
  <div style="margin-bottom: 24px; text-align: left;">
    <%= f.label :memo, "メモ", style: "
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <%= f.text_area :memo, 
        style: "
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          min-height: 100px;
          resize: vertical;
          background-color: white;
          color: black;
        ",
        placeholder: "ギフトに関するメモ、思い出、相手の反応など...",
        class: "gift-form-input",
        maxlength: 100 %>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      ギフトに関する思い出やメモを自由に記録してください（任意、最大100文字）
    </div>
    
    <% if gift_record.errors[:memo].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:memo].first %>
      </div>
    <% end %>
  </div>

  <!-- 画像アップロード -->
  <div class="mb-6 text-left">
    <%= f.label :images, "ギフト画像", class: "block mb-2 text-sm font-semibold text-gray-700" %>
    
    <!-- ファイル選択エリア -->
    <div class="
      border-2 border-dashed border-gray-300 
      rounded-lg 
      py-8 px-5 
      text-center 
      bg-gray-50 
      transition-all duration-300 ease-in-out 
      cursor-pointer 
      relative
      hover:border-orange-400 hover:bg-orange-50
      focus-within:border-orange-400 focus-within:bg-orange-50
      group
    " 
    data-image-preview-target="dropZone"
    data-action="
      dragover->image-preview#dragOver 
      dragleave->image-preview#dragLeave 
      drop->image-preview#drop
      click->image-preview#clickInput
    "
    role="button"
    tabindex="0"
    aria-label="画像ファイルをアップロード">
      
      <!-- 隠しファイル入力 -->
      <%= f.file_field :images, 
          multiple: true, 
          accept: "image/jpeg,image/jpg,image/png,image/webp",
          class: "sr-only",
          id: "gift_record_images",
          data: { 
            image_preview_target: "fileInput",
            action: "change->image-preview#previewImages"
          },
          aria: { describedby: "image_upload_help" } %>
      
      <!-- アップロードエリアの内容 -->
      <div data-image-preview-target="uploadPrompt" class="transition-colors duration-200">
        <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4 block group-hover:text-orange-500 transition-colors duration-200"></i>
        <p class="text-base text-gray-600 mb-2 font-medium group-hover:text-gray-700">
          画像をドラッグ&ドロップ または クリックして選択
        </p>
        <p class="text-xs text-gray-500 mb-0">
          JPEG, PNG, WEBP形式 / 最大10MB / 5枚まで
        </p>
      </div>
    </div>
    
    <!-- 画像プレビューエリア -->
    <div id="image_preview_container" 
         data-image-preview-target="previewContainer" 
         class="mt-4 hidden">
      <h6 class="text-sm font-semibold text-gray-700 mb-3">
        選択された画像 (<span data-image-preview-target="imageCount" class="text-orange-600">0</span>枚)
      </h6>
      <div data-image-preview-target="previewGrid" 
           class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
      </div>
      <button type="button" 
              class="mt-3 text-xs text-gray-500 hover:text-red-600 transition-colors duration-200"
              data-action="click->image-preview#clearAll">
        <i class="fas fa-trash-alt mr-1"></i>すべてクリア
      </button>
    </div>
    
    <!-- 既存画像の表示（編集時） -->
    <% if gift_record.persisted? && gift_record.images.attached? %>
      <div class="mt-4" data-image-preview-target="existingImagesContainer">
        <h6 class="text-sm font-semibold text-gray-700 mb-3">
          現在の画像 (<span data-image-preview-target="existingImageCount"><%= gift_record.images.count %></span>枚)
        </h6>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" data-image-preview-target="existingImagesGrid">
          <% gift_record.images.each_with_index do |image, index| %>
            <div class="relative group" data-image-id="<%= image.id %>" data-image-preview-target="existingImageItem">
              <div class="aspect-square rounded-lg overflow-hidden bg-gray-100 border border-gray-200">
                <%= image_tag image.variant(resize_to_fill: [150, 150]), 
                    class: "w-full h-full object-cover", 
                    alt: "現在のギフト画像 #{index + 1}" %>
              </div>
              <!-- 削除ボタン -->
              <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <button type="button" 
                        class="w-6 h-6 bg-red-500 hover:bg-red-600 text-white text-xs rounded-full flex items-center justify-center shadow-lg transition-colors duration-200"
                        data-action="click->image-preview#deleteExistingImage"
                        data-image-id="<%= image.id %>"
                        aria-label="画像を削除">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          <% end %>
        </div>
        <button type="button" 
                class="mt-3 text-xs text-gray-500 hover:text-red-600 transition-colors duration-200 hidden"
                data-image-preview-target="restoreAllButton"
                data-action="click->image-preview#restoreAllExistingImages">
          <i class="fas fa-undo mr-1"></i>すべて復元
        </button>
      </div>
    <% end %>
    
    <!-- ヘルプテキスト -->
    <div id="image_upload_help" class="text-xs text-gray-500 mt-2">
      <i class="fas fa-info-circle mr-1"></i>
      ギフトの画像を追加してください（任意、最大5枚まで）
    </div>
    
    <!-- エラーメッセージ -->
    <% if gift_record.errors[:images].any? %>
      <div class="text-red-600 text-xs mt-2" role="alert">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        <% gift_record.errors[:images].each do |error| %>
          <div><%= error %></div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- ギフト分類設定（編集画面のみ表示） -->
  <% if gift_record.persisted? %>
  <div style="margin-bottom: 32px; text-align: left;">
    <%= f.label :gift_direction, "ギフトの分類", style: "
      display: block;
      margin-bottom: 16px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <div style="
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      background-color: #f8f9fa;
    ">
      <!-- カスタムトグルスイッチ -->
      <div style="position: relative; margin-right: 16px;">
        <%= f.check_box :gift_direction, 
            {
              checked: default_gift_direction_checked?(gift_record, :received),
              style: "display: none;",
              id: "gift_record_gift_direction",
              data: { gift_records_target: "giftDirectionToggle" }
            }, "received", "given" %>
        <label for="gift_record_gift_direction" style="
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
          background-color: #28a745;
          border-radius: 34px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        " id="gift_direction_toggle_label" 
        data-gift-records-target="giftDirectionToggleLabel"
        data-action="click->gift-records#toggleGiftDirectionStatus">
          <span style="
            position: absolute;
            content: '';
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            transform: translateX(26px);
          " id="gift_direction_toggle_slider" data-gift-records-target="giftDirectionToggleSlider"></span>
        </label>
      </div>
      
      <!-- ラベルテキスト -->
      <div>
        <div style="
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
          font-size: 16px;
        " id="gift_direction_toggle_text">
          <i class="fas fa-gift" style="margin-right: 8px; color: #28a745;" id="gift_direction_toggle_icon" data-gift-records-target="giftDirectionToggleIcon"></i>
          <span id="gift_direction_toggle_status" data-gift-records-target="giftDirectionToggleStatus">贈ったギフト</span>
        </div>
        <div style="
          font-size: 12px;
          color: #666;
        " id="gift_direction_toggle_description" data-gift-records-target="giftDirectionToggleDescription">
          あなたが贈ったギフトを記録します
        </div>
      </div>
    </div>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      贈ったギフトか、もらったギフトか選択してください
    </div>
    
    <% if gift_record.errors[:gift_direction].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:gift_direction].first %>
      </div>
    <% end %>
  </div>
  <% end %>

  <!-- コメント設定 -->
  <div style="margin-bottom: 32px; text-align: left;">
    <%= f.label :commentable, "コメント設定", style: "
      display: block;
      margin-bottom: 16px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <div style="
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      background-color: #f8f9fa;
    ">
      <!-- カスタムトグルスイッチ -->
      <div style="position: relative; margin-right: 16px;">
        <%= f.check_box :commentable, 
            {
              checked: gift_record.new_record? ? true : gift_record.commentable,
              style: "display: none;",
              id: "gift_record_commentable",
              data: { gift_records_target: "commentableToggle" }
            } %>
        <label for="gift_record_commentable" style="
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
          background-color: #007bff;
          border-radius: 34px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        " id="commentable_toggle_label" 
        data-gift-records-target="commentableToggleLabel"
        data-action="click->gift-records#toggleCommentableStatus">
          <span style="
            position: absolute;
            content: '';
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
          " id="commentable_toggle_slider" data-gift-records-target="commentableToggleSlider"></span>
        </label>
      </div>
      
      <!-- ラベルテキスト -->
      <div>
        <div style="
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
          font-size: 16px;
        " id="commentable_toggle_text">
          <i class="fas fa-comments" style="margin-right: 8px; color: #007bff;" id="commentable_toggle_icon" data-gift-records-target="commentableToggleIcon"></i>
          <span id="commentable_toggle_status" data-gift-records-target="commentableToggleStatus">コメント可能</span>
        </div>
        <div style="
          font-size: 12px;
          color: #666;
        " id="commentable_toggle_description" data-gift-records-target="commentableToggleDescription">
          他のユーザーがこのギフト記録にコメントできます
        </div>
      </div>
    </div>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      オンにすると他のユーザーがあなたのギフト記録にコメントできます
    </div>
    
    <% if gift_record.errors[:commentable].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:commentable].first %>
      </div>
    <% end %>
  </div>

  <!-- 公開設定 -->
  <div style="margin-bottom: 32px; text-align: left;">
    <%= f.label :is_public, "公開設定", style: "
      display: block;
      margin-bottom: 16px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    " %>
    <div style="
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      background-color: #f8f9fa;
    ">
      <!-- カスタムトグルスイッチ -->
      <div style="position: relative; margin-right: 16px;">
        <%= f.check_box :is_public, 
            {
              checked: gift_record.new_record? ? true : gift_record.is_public,
              style: "display: none;",
              id: "gift_record_is_public",
              data: { gift_records_target: "publicToggle" }
            } %>
        <label for="gift_record_is_public" style="
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
          background-color: #28a745;
          border-radius: 34px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        " id="toggle_label" 
        data-gift-records-target="toggleLabel"
        data-action="click->gift-records#togglePublicStatus">
          <span style="
            position: absolute;
            content: '';
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
          " id="toggle_slider" data-gift-records-target="toggleSlider"></span>
        </label>
      </div>
      
      <!-- ラベルテキスト -->
      <div>
        <div style="
          font-weight: 600;
          color: #333;
          margin-bottom: 4px;
          font-size: 16px;
        " id="toggle_text">
          <i class="fas fa-globe" style="margin-right: 8px; color: #28a745;" id="toggle_icon" data-gift-records-target="toggleIcon"></i>
          <span id="toggle_status" data-gift-records-target="toggleStatus">公開</span>
        </div>
        <div style="
          font-size: 12px;
          color: #666;
        " id="toggle_description" data-gift-records-target="toggleDescription">
          他のユーザーがこのギフト記録を見ることができます
        </div>
      </div>
    </div>
    
    <div style="font-size: 12px; color: #888; margin-top: 8px;">
      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
      公開にすると他のユーザーがあなたのギフト記録を参考にできます
    </div>
    
    <% if gift_record.errors[:is_public].any? %>
      <div style="color: #dc3545; font-size: 12px; margin-top: 8px;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
        <%= gift_record.errors[:is_public].first %>
      </div>
    <% end %>
  </div>

  <!-- 送信ボタン -->
  <div style="margin-bottom: 32px;">
    <%= f.submit nil, style: "
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #FC913A 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    " %>
  </div>
<% end %>

<!-- エラー時の状態をJavaScript側に渡すためのデータ属性 -->
<% if @gift_person&.errors&.any? %>
  <div id="gift_person_error_flag" data-has-error="true" style="display: none;"></div>
<% end %>
