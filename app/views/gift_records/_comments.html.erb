<%# コメント機能セクション %>
<div class="mt-8" id="comments-section">
  <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
    <i class="fas fa-comments text-blue-500 mr-2"></i>
    コメント
    <span class="ml-2 text-sm font-normal text-gray-500">
      (<%= @gift_record.comments.count %>件)
    </span>
  </h2>

  <!-- コメント投稿フォーム -->
  <% if @gift_record.commentable? %>
    <% if user_signed_in? %>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
        <%= form_with model: [@gift_record, Comment.new], id: "comment-form", data: { turbo: false } do |form| %>
          <div class="space-y-4">
            <div>
              <%= form.label :body, "コメントを投稿", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :body, 
                  placeholder: "このギフトについてコメントを書いてください...", 
                  rows: 3,
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                  style: "background-color: white; color: black;",
                  maxlength: 100 %>
              <div class="text-xs text-gray-500 mt-1">
                100文字以内で入力してください
              </div>
            </div>
            
            <div class="flex justify-end">
              <%= form.submit "コメントを投稿", 
                  class: "px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors",
                  id: "comment-submit-btn" %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 text-center">
        <p class="text-gray-600 text-sm">
          コメントを投稿するには
          <%= link_to "ログイン", new_user_session_path, class: "text-blue-600 hover:text-blue-800 font-medium" %>
          してください
        </p>
      </div>
    <% end %>
  <% else %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-center">
      <div class="flex justify-center items-center mb-2">
        <i class="fas fa-comment-slash text-yellow-600 mr-2"></i>
        <p class="text-yellow-800 text-sm font-medium">コメント機能が無効になっています</p>
      </div>
      <p class="text-yellow-700 text-xs">
        この投稿者がコメント機能を無効に設定しているため、コメントを投稿することはできません。
      </p>
    </div>
  <% end %>

  <!-- コメント一覧 -->
  <div id="comments-list" class="space-y-4">
    <% if @gift_record.comments.any? %>
      <% @gift_record.comments.oldest_first.each do |comment| %>
        <div class="comment-item bg-white border border-gray-200 rounded-lg p-4" id="comment-<%= comment.id %>">
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-blue-600 text-sm"></i>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-900">
                  <%= comment.user.display_name %>
                </p>
                <p class="text-xs text-gray-500">
                  <%= comment.display_created_at %>
                </p>
              </div>
            </div>
            
            <% if user_signed_in? && comment.can_edit_or_delete?(current_user) %>
              <div class="flex space-x-2">
                <button type="button" 
                        class="text-gray-400 hover:text-blue-600 text-sm"
                        data-action="click->comments#editComment"
                        data-comment-id="<%= comment.id %>"
                        title="編集">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" 
                        class="text-gray-400 hover:text-red-600 text-sm"
                        data-action="click->comments#deleteComment"
                        data-comment-id="<%= comment.id %>"
                        title="削除">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            <% end %>
          </div>
          
          <div class="comment-body text-sm text-gray-700 whitespace-pre-line pl-11">
            <%= simple_format(comment.body) %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-8 text-gray-500">
        <i class="fas fa-comment-dots text-3xl mb-3"></i>
        <p class="text-sm">まだコメントがありません</p>
        <% if user_signed_in? %>
          <p class="text-xs mt-1">最初のコメントを投稿してみませんか？</p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- コメント編集モーダル -->
<div id="edit-comment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900">コメントを編集</h3>
      <button type="button" 
              data-action="click->comments#closeEditModal"
              class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="edit-comment-form" action="" method="patch">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <div class="mb-4">
        <label for="edit-comment-body" class="block text-sm font-medium text-gray-700 mb-2">コメント</label>
        <textarea id="edit-comment-body" 
                  name="comment[body]" 
                  rows="3" 
                  maxlength="100"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                  style="background-color: white; color: black;"></textarea>
        <div class="text-xs text-gray-500 mt-1">100文字以内で入力してください</div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" 
                data-action="click->comments#closeEditModal"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
          キャンセル
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
          更新
        </button>
      </div>
    </form>
  </div>
</div>