<% content_for(:title, "マイギフト記録一覧") %>
<!-- メインコンテナ - 中央寄せ -->
<div class="max-w-6xl mx-auto">
  <!-- ヘッダー部分 -->
  <div class="mb-2 mt-2 text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-3">
      じぶんのギフト
    </h2>
  </div>

  <!-- 統計情報 -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 max-w-4xl mx-auto">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
      <div>
        <div class="text-2xl font-bold text-primary"><%= @total_records %></div>
        <div class="text-sm text-gray-600">総記録数</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-green-600"><%= @public_records_count %></div>
        <div class="text-sm text-gray-600">公開記録</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-gray-600"><%= @private_records_count %></div>
        <div class="text-sm text-gray-600">非公開記録</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-blue-600"><%= @current_month_records %></div>
        <div class="text-sm text-gray-600">今月の記録</div>
      </div>
    </div>
  </div>

  <!-- 検索・フィルター機能 -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-2 mb-2 max-w-4xl mx-auto" data-controller="dynamic-filter">
    <%= form_with url: my_index_gift_records_path, method: :get, local: true, class: "space-y-2" do |f| %>
      <!-- フィルターと値 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <!-- フィルタータイプ選択 -->
        <div>
          <%= f.label :filter_type, "フィルター", class: "block text-xs font-medium text-gray-700 mb-0.5" %>
          <%= f.select :filter_type, 
              options_for_select([
                ["選択してください", ""],
                ["ギフト相手", "gift_person"],
                ["関係性", "relationship"],
                ["イベント", "event"]
              ], params[:filter_type]),
              {},
              { 
                id: "filter-type-select",
                data: { "dynamic-filter-target": "filterTypeSelect", action: "change->dynamic-filter#update" },
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary",
                style: "background-color: white; color: black;"
              } %>
          <%= f.hidden_field :filter_type, id: "filter-type-hidden", data: { "dynamic-filter-target": "filterTypeHidden" } %>
        </div>

        <!-- 動的フィルター値選択 -->
        <div>
          <%= f.label :filter_value, "詳細", class: "block text-xs font-medium text-gray-700 mb-0.5" %>
          
          <!-- ギフト相手選択プルダウン -->
          <%= f.select :gift_person_id, 
              options_for_select([["すべて", ""]] + @gift_people_options, params[:gift_person_id]),
              {},
              { 
                id: "gift-person-select",
                data: { "dynamic-filter-target": "giftPersonSelect" },
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary #{params[:filter_type] == 'gift_person' ? '' : 'hidden'}",
                style: "background-color: white; color: black;"
              } %>
          
          <!-- 関係性選択プルダウン -->
          <%= f.select :relationship_id, 
              options_for_select([["すべて", ""]] + @relationship_options, params[:relationship_id]),
              {},
              { 
                id: "relationship-select",
                data: { "dynamic-filter-target": "relationshipSelect" },
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary #{params[:filter_type] == 'relationship' ? '' : 'hidden'}",
                style: "background-color: white; color: black;"
              } %>
          
          <!-- イベント選択プルダウン -->
          <%= f.select :event_id, 
              options_for_select([["すべて", ""]] + @event_options, params[:event_id]),
              {},
              { 
                id: "event-select",
                data: { "dynamic-filter-target": "eventSelect" },
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary #{params[:filter_type] == 'event' ? '' : 'hidden'}",
                style: "background-color: white; color: black;"
              } %>
          
          <!-- プレースホルダー表示 -->
          <div id="filter-placeholder" data-dynamic-filter-target="placeholder" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm text-gray-500 <%= params[:filter_type].present? ? 'hidden' : '' %>" 
              style="background-color: white;">
          フィルターを選択してください
          </div>
        </div>
      </div>

      <!-- 並び替え -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <!-- 並び替えタイプ -->
        <div>
          <%= f.label :sort_by, "並び替え", class: "block text-xs font-medium text-gray-700 mb-0.5" %>
          <%= f.select :sort_by, 
              options_for_select([
                ["投稿日", "created_at"],
                ["お気に入り順", "favorites"]
              ], params[:sort_by]),
              { prompt: "選択してください" },
              { 
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary",
                style: "background-color: white; color: black;"
              } %>
        </div>

        <!-- 並び順 -->
        <div>
          <%= f.label :sort_order, "順序", class: "block text-xs font-medium text-gray-700 mb-0.5" %>
          <%= f.select :sort_order, 
              options_for_select([
                ["昇順", "asc"],
                ["降順", "desc"]
              ], params[:sort_order]),
              { prompt: "選択してください" },
              { 
                class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary",
                style: "background-color: white; color: black;"
              } %>
        </div>
      </div>

      <!-- 検索欄と検索ボタン -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <!-- 検索キーワード（オートコンプリート付き） -->
        <div class="relative" data-controller="gift-records-autocomplete">
          <%= f.label :search, "検索", class: "block text-xs font-medium text-gray-700 mb-0.5" %>
          <%= f.text_field :search, 
              value: params[:search],
              placeholder: "アイテム名、メモ、相手名で検索",
              id: "gift-records-search-input",
              autocomplete: "off",
              data: { "gift-records-autocomplete-target": "input" },
              class: "w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary",
              style: "background-color: white; color: black;" %>
          
          <!-- オートコンプリートドロップダウン -->
          <div id="gift-records-autocomplete-dropdown" 
              data-gift-records-autocomplete-target="dropdown"
              class="absolute z-50 w-full mt-0.5 bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-48 overflow-y-auto">
            <!-- 検索結果がここに動的に追加される -->
          </div>
          
          <!-- ローディング表示 -->
          <div id="gift-records-search-loading" 
              data-gift-records-autocomplete-target="loading"
              class="absolute right-2 top-7 hidden">
            <i class="fas fa-spinner fa-spin text-gray-400 text-sm"></i>
          </div>
        </div>

        <!-- 検索ボタン -->
        <div class="flex items-end">
          <%= f.submit "この条件で検索する", class: "w-full px-3 py-1.5 btn-primary text-white text-sm font-medium rounded-md hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" %>
        </div>
      </div>

      <% if params[:search].present? || params[:gift_person_id].present? || params[:relationship_id].present? || params[:event_id].present? || params[:sort_by].present? %>
        <div class="flex items-center justify-between pt-1.5 border-t border-gray-200">
          <span class="text-xs text-gray-600">
            <%= pluralize(@total_records, "件") %>の結果
          </span>
          <%= link_to "クリア", my_index_gift_records_path, class: "text-xs text-primary hover:text-primary-hover" %>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- ギフト記録一覧 -->
  <% if @gift_records.any? %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <% @gift_records.each do |gift_record| %>
        <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow">
          <!-- 画像部分 -->
          <div class="aspect-w-16 aspect-h-9 bg-gray-100">
            <% if gift_record.images.any? %>
              <%= image_tag gift_record.images.first, 
                  class: "w-full h-48 object-cover",
                  alt: gift_record.item_name %>
            <% else %>
              <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                <i class="fas fa-gift text-4xl text-gray-400"></i>
              </div>
            <% end %>
          </div>

          <!-- コンテンツ部分 -->
          <div class="p-4">
            <!-- 公開/非公開ステータス -->
            <div class="flex items-center justify-between mb-2">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= gift_record.is_public? ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                <i class="<%= gift_record.is_public? ? 'fas fa-globe' : 'fas fa-lock' %> mr-1"></i>
                <%= gift_record.is_public? ? '公開' : '非公開' %>
              </span>
              <span class="text-xs text-gray-500">
                <%= l(gift_record.gift_at, format: :short) %>
              </span>
            </div>

            <!-- アイテム名 -->
            <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate">
              <%= gift_record.item_name %>
            </h3>

            <!-- ギフト相手と関係性 -->
            <div class="flex items-center text-sm text-gray-600 mb-2">
              <i class="fas fa-user mr-1"></i>
              <%= gift_record.gift_person.name %>
              <% if gift_record.gift_person.relationship %>
                <span class="mx-1">·</span>
                <%= gift_record.gift_person.relationship.name %>
              <% end %>
            </div>

            <!-- イベント -->
            <% if gift_record.event %>
              <div class="flex items-center text-sm text-gray-600 mb-3">
                <i class="fas fa-calendar mr-1"></i>
                <%= gift_record.event.name %>
              </div>
            <% end %>

            <!-- アクションボタン -->
            <div class="flex space-x-2">
              <%= link_to gift_record_path(gift_record),
                  class: "flex-1 text-center bg-blue-500 text-white px-3 py-2 text-sm rounded-md hover:bg-blue-600 focus:outline-none" do %>
                <i class="fas fa-eye mr-1"></i>
                詳細
              <% end %>
              <%= link_to edit_gift_record_path(gift_record),
                  class: "flex-1 text-center bg-green-500 text-white px-3 py-2 text-sm rounded-md hover:bg-green-600 focus:outline-none" do %>
                <i class="fas fa-edit mr-1"></i>
                編集
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- ページネーション -->
    <% if @gift_records.respond_to?(:current_page) && @gift_records.total_pages > 1 %>
      <div class="flex justify-center">
        <%= paginate @gift_records, params: @pagination_params %>
      </div>
    <% end %>
  <% else %>
    <!-- 空の状態 -->
    <div class="text-center py-12">
      <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-gift text-4xl text-gray-400"></i>
      </div>
      <h3 class="text-xl font-medium text-gray-900 mb-2">まだギフト記録がありません</h3>
      <p class="text-gray-500 mb-6">最初のギフト記録を作成してみましょう！</p>
      <%= link_to new_gift_record_path,
          class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" do %>
        <i class="fas fa-plus mr-2"></i>
        ギフト記録を作成
      <% end %>
    </div>
  <% end %>
</div>
