<% content_for(:title, "マイギフト記録一覧") %>
<!-- メインコンテナ - 中央寄せ -->
<div class="gift-records-container">
  <!-- ヘッダー部分 -->
  <div class="mb-2 mt-2 text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-3">
      じぶんのギフト
    </h2>
  </div>

  <!-- 統計情報 -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 w-full">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
      <div>
        <div class="text-2xl font-bold text-primary"><%= @total_records %></div>
        <div class="text-sm text-gray-600">総記録数</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-green-600"><%= @public_records_count %></div>
        <div class="text-sm text-gray-600">公開記録</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-gray-600"><%= @private_records_count %></div>
        <div class="text-sm text-gray-600">非公開記録</div>
      </div>
      <div>
        <div class="text-2xl font-bold text-blue-600"><%= @current_month_records %></div>
        <div class="text-sm text-gray-600">今月の記録</div>
      </div>
    </div>
  </div>

  <!-- 検索・フィルター機能 -->
  <%= render 'shared/filter_form',
      form_url: my_index_gift_records_path,
      relationship_options: @relationship_options,
      event_options: @event_options,
      gift_item_category_options: @gift_item_category_options,
      gift_people_options: @gift_people_options,
      gift_direction_options: @gift_direction_options,
      gender_options: [["男性", "male"], ["女性", "female"]],
      public_filter_options: [
        ["すべて", ""],
        ["公開", "public"],
        ["非公開", "private"]
      ],
      filter_type_options: [
        ["選択してください", ""],
        ["ギフト相手", "gift_person"],
        ["関係性", "relationship"],
        ["イベント", "event"],
        ["カテゴリ", "gift_item_category"],
        ["公開設定", "is_public"],
        ["ギフト種別", "gift_direction"],
        ["年齢", "age"],
        ["性別", "gender"]
      ],
      age_options: [["10代", "10s"], ["20代", "20s"], ["30代", "30s"], ["40代", "40s"], ["50代", "50s"], ["60代", "60s"], ["70代", "70s"], ["80代以上", "80plus"]],
      search_placeholder: "アイテム名、メモ、相手名で検索",
      total_records: @total_records,
      active_filter_params: [:search, :gift_person_id, :relationship_id, :age_group, :gender, :event_id, :gift_item_category_id, :sort_by, :is_public, :gift_direction]
    %>

  <!-- ギフト記録一覧 -->
  <div class="gift-records-grid mb-6">
    <% if @gift_records.any? %>
      <% @gift_records.each do |gift_record| %>
        <% detail_path = gift_record_path(gift_record, @pagination_params.merge(page: params[:page], origin: 'my')) %>
        <div class="gift-card-container gift-record-card bg-white rounded-lg shadow-md overflow-hidden"
             onclick="window.location.href='<%= detail_path %>'"
             style="cursor: pointer;">
          <!-- 画像部分（一覧と同じ表示・固定高さ） -->
          <div class="gift-card-image relative overflow-hidden">
            <a href="<%= detail_path %>"
               class="absolute inset-0 z-[4]"
               onclick="event.stopPropagation()"
               aria-label="ギフト詳細へ移動"></a>
            <% if gift_record.has_images? %>
              <%= gift_main_image_with_fallback(gift_record,
                    size: [400, 300],
                    css_class: "w-full h-full object-cover",
                    loading: "lazy") %>
            <% else %>
              <div class="gift-image-placeholder">
                <div class="text-center">
                  <div class="w-16 h-16 sm:w-18 sm:h-18 lg:w-18 lg:h-18 xl:w-20 xl:h-20 mx-auto mb-2 sm:mb-3 bg-white rounded-full flex items-center justify-center shadow-sm">
                    <i class="fas fa-gift text-2xl sm:text-2xl lg:text-2xl xl:text-3xl text-primary"></i>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <!-- コンテンツ部分 -->
          <div class="p-4">
            <!-- 公開/非公開ステータス -->
            <div class="flex items-center justify-between mb-2">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= gift_record.is_public? ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                <i class="<%= gift_record.is_public? ? 'fas fa-globe' : 'fas fa-lock' %> mr-1"></i>
                <%= gift_record.is_public? ? '公開' : '非公開' %>
              </span>
              <span class="text-xs text-gray-500">
                <%= l(gift_record.gift_at, format: :short) %>
              </span>
            </div>

            <!-- アイテム名 -->
            <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate">
              <%= gift_record.item_name %>
            </h3>

            <!-- ギフト相手と関係性 -->
            <div class="flex items-center text-sm text-gray-600 mb-2">
              <i class="fas fa-user mr-1"></i>
              <%= gift_record.gift_person.name %>
              <% if gift_record.gift_person.relationship %>
                <span class="mx-1">·</span>
                <%= gift_record.gift_person.relationship.name %>
              <% end %>
            </div>

            <!-- イベント -->
            <% if gift_record.event %>
              <div class="flex items-center text-sm text-gray-600 mb-3">
                <i class="fas fa-calendar mr-1"></i>
                <%= gift_record.event.name %>
              </div>
            <% end %>

            <% if gift_record.memo.present? %>
              <div class="hidden sm:block mt-3 pt-3 border-t border-gray-200">
                <p class="text-xs leading-relaxed text-gray-500">
                  <i class="fas fa-sticky-note mr-1 text-yellow-500"></i>
                  <%= truncate(gift_record.memo, length: 41) %>
                </p>
              </div>
            <% end %>

            <!-- アクションボタン -->
            <div class="flex">
              <% edit_params = (@pagination_params || {}).merge(page: params[:page], origin: 'my') %>
              <%= link_to edit_gift_record_path(gift_record, edit_params),
                  class: "flex-1 text-center bg-green-500 text-white px-3 py-2 text-sm rounded-md hover:bg-green-600 focus:outline-none",
                  onclick: "event.stopPropagation();" do %>
                <i class="fas fa-edit mr-1"></i>
                編集
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <% filter_keys = [:search, :gift_person_id, :relationship_id, :age_group, :gender, :event_id, :gift_item_category_id, :sort_by, :is_public, :gift_direction] %>
      <% has_filters = filter_keys.any? { |key| params[key].present? } %>
      <% secondary_action = if has_filters
           {
             url: my_index_gift_records_path,
             icon: 'fas fa-list',
             label: 'すべて表示'
           }
         end %>
      <% primary_action = {
           url: new_gift_record_path,
           icon: 'fas fa-plus',
           label: 'ギフト記録を作成',
           class: 'inline-flex items-center px-3 py-1.5 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-primary hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary'
         } %>
      <% empty_title = has_filters ? '検索結果が見つかりませんでした' : 'まだギフト記録がありません' %>
      <% empty_body = has_filters ? '検索条件を変更して再度お試しください。' : '最初のギフト記録を作成してみましょう！' %>

      <div class="gift-card-container col-span-full flex justify-center">
        <div class="w-[165px] sm:w-[165px] md:w-[240px] lg:w-[200px] xl:w-[200px]">
          <%= render 'shared/empty_state',
              icon: 'fas fa-gift',
              title: empty_title,
              body: empty_body,
              primary_action: primary_action,
              secondary_action: secondary_action %>
        </div>
      </div>
    <% end %>
  </div>

  <% if @gift_records.any? && @gift_records.respond_to?(:current_page) %>
    <%= render 'shared/pagination',
        collection: @gift_records,
        page_path: ->(page_number) { my_index_gift_records_path(@pagination_params.merge(page: page_number)) } %>
  <% end %>
</div>
